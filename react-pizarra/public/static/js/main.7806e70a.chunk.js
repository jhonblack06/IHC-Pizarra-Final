(this.webpackJsonpfrontend=this.webpackJsonpfrontend||[]).push([[0],{103:function(t,e,n){},104:function(t,e,n){"use strict";n.r(e);var a=n(2),c=n(0),i=n.n(c),r=n(17),o=n.n(r),s=n(18),l=n(24),u=n(63),d=n(6),f=function(t){t&&t instanceof Function&&n.e(3).then(n.bind(null,108)).then((function(e){var n=e.getCLS,a=e.getFID,c=e.getFCP,i=e.getLCP,r=e.getTTFB;n(t),a(t),c(t),i(t),r(t)}))},h=n(21),j=n.n(h),p=n(32),b=n(33),m=n.n(b),v="https://murcielago.pe:5000",O=m()(v,{transports:["websocket"],path:"/bridge"}),g=function(t){return new Promise((function(e){return setTimeout(e,t)}))},x=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return Math.floor(Math.random()*(e-t+1))+t},y=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1500;return g(x(t,e))};function S(t){return C.apply(this,arguments)}function C(){return(C=Object(p.a)(j.a.mark((function t(e){var n,a,c,i,r=arguments;return j.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],a=r.length>2&&void 0!==r[2]?r[2]:{},t.next=4,y();case 4:return a.headers={"Content-Type":"application/json",Accept:"application/json"},c=v+e,n&&(c=v+"/api"+e,a.headers.authorization="Bearer "+localStorage.getItem("token")),t.next=9,fetch(c,a);case 9:return i=t.sent,t.next=12,i.json();case 12:return t.abrupt("return",t.sent);case 13:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var k={auth:{login:function(t){return S("/login",!1,{method:"POST",body:JSON.stringify(t)})},validate:function(){return S("/validate",!0)}},empresas:{list:function(t){return S("/empresas".concat(t&&"?min=true"),!0)}},unidades:{list:function(t,e){return S("/unidades?empresa=".concat(t).concat(e&&"&min=true"),!0)}},tracker:{list:function(t,e){return S("/tracker?empresa=".concat(t,"&unidad=").concat(e),!1)},unidad:function(t,e){return S("/tracker/unidad?empresa=".concat(t,"&unidad=").concat(e),!1)}},cajas:{list:function(t){return S("/cajas?empresa=".concat(t),!1)}},mensajes:{enviar:function(t){return S("/mensajes",!0,{method:"POST",body:JSON.stringify(t)})}},dietas:{list:function(t,e){return S("/dietas?page="+t+"&max="+e,!0)},search:function(t,e,n){return S("/dietas?query="+t+"&page="+e+"&max="+n,!0)},create:function(t){return S("/badges",!0,{method:"POST",body:JSON.stringify(t)})},read:function(t){},update:function(t,e){},remove:function(t){}},socket:{getMarkers:function(t){O.on("get",(function(e){return t(null,e)}))},on:function(){O.on("get",(function(t){console.log(t)}))},emit:function(t,e){O.emit(t,e)}}},I=n(14),w=function(t,e){switch(e.type){case"SET_AUTH":return Object(I.a)(Object(I.a)({},t),{},{isAuth:e.payload});case"SET_MOBILE_OPEN":return Object(I.a)(Object(I.a)({},t),{},{isMobileOpen:e.payload});case"SET_MINI_ACTIVE":return Object(I.a)(Object(I.a)({},t),{},{isMiniActive:e.payload});default:return t}},D=n(45),N=n(10),E=n(106),T=n(107);n(99);var A=function(t){return t.isOpen?o.a.createPortal(Object(a.jsx)("div",{className:"Modal",children:Object(a.jsx)("i",{className:"fas fa-spinner fa-pulse fa-3x"})}),document.getElementById("modal")):null};var M={setAuth:function(t){return{type:"SET_AUTH",payload:t}}},F=Object(s.b)((function(t){return{isAuth:t.isAuth}}),M)((function(t){var e=i.a.useState(""),n=Object(N.a)(e,2),c=n[0],r=n[1],o=i.a.useState(""),s=Object(N.a)(o,2),l=s[0],u=s[1],d=i.a.useState(!1),f=Object(N.a)(d,2),h=f[0],b=f[1],m=i.a.useState(!1),v=Object(N.a)(m,2),O=v[0],g=v[1],x=function(){var e=Object(p.a)(j.a.mark((function e(n){var a;return j.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.preventDefault(),b(!0),g(!1),console.log("Login",c,l),e.prev=4,e.next=7,k.auth.login({user:c,pass:l});case 7:"ok"===(a=e.sent).msg?(localStorage.setItem("id",a.data.id),localStorage.setItem("name",a.data.name),localStorage.setItem("token",a.data.token),t.setAuth(!0),t.history.push("/")):(b(!1),g(!0)),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(4),b(!1),g(!0);case 15:case"end":return e.stop()}}),e,null,[[4,11]])})));return function(t){return e.apply(this,arguments)}}();return Object(a.jsxs)(a.Fragment,{children:[Object(a.jsx)(A,{isOpen:h}),Object(a.jsxs)("div",{className:"container main-window",children:[Object(a.jsx)("h1",{children:"Login"}),O&&Object(a.jsx)("div",{style:{backgroundColor:"#f44336",padding:8,borderRadius:8},children:Object(a.jsx)("span",{className:"h4",style:{color:"#fff"},children:"Error de inicio de sesi\xf3n"})}),Object(a.jsxs)(E.a,{onSubmit:x,children:[Object(a.jsx)(E.a.Group,{controlId:"formBasicEmail",children:Object(a.jsx)("input",{type:"text",className:"txt-clientId",name:"user",placeholder:"Usuario",value:c,onChange:function(t){r(t.target.value.trim())}})}),Object(a.jsx)(E.a.Group,{controlId:"formBasicPassword",children:Object(a.jsx)("input",{type:"password",className:"txt-clientId",name:"pass",placeholder:"Contrase\xf1a",value:l,onChange:function(t){u(t.target.value.trim())}})}),Object(a.jsx)("br",{}),Object(a.jsx)(T.a,{variant:"info",type:"submit",size:"lg",style:{marginLeft:16},children:"Ingresar"})]})]})]})})),P=n(11),_=n(12),H=n(22),R=n(20),V=n(19),L=n(13),B=n.n(L),J=m()("https://murcielago.pe:5000",{path:"/bridge"}),U=function(){function t(){Object(P.a)(this,t),this.events={}}return Object(_.a)(t,[{key:"emit",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),a=1;a<e;a++)n[a-1]=arguments[a];return this.events[t]&&this.events[t].forEach((function(t){return t.apply(void 0,n)})),this}},{key:"on",value:function(t,e){return this.events[t]?this.events[t].push(e):this.events[t]=[e],this}},{key:"off",value:function(t,e){if(t&&B.a.isFunction(e)){var n=this.events[t],a=n.findIndex((function(t){return t===e}));n.splice(a,1)}else this.events[t]=[];return this}}]),t}(),W=function(t){Object(R.a)(n,t);var e=Object(V.a)(n);function n(){return Object(P.a)(this,n),e.apply(this,arguments)}return Object(_.a)(n,[{key:"start",value:function(){var t=this;return navigator.mediaDevices.getUserMedia({video:{facingMode:"user",height:{min:360,ideal:720,max:1080}},audio:!0}).then((function(e){t.stream=e,t.emit("stream",e)})).catch((function(t){t instanceof DOMException?alert("Cannot open webcam and/or microphone"):console.log(t)})),this}},{key:"toggle",value:function(t,e){var n=arguments.length;return this.stream&&this.stream["get".concat(t,"Tracks")]().forEach((function(t){var a=2===n?e:!t.enabled;B.a.set(t,"enabled",a)})),this}},{key:"stop",value:function(){return this.stream&&this.stream.getTracks().forEach((function(t){return t.stop()})),this}}]),n}(U),q={iceServers:[{urls:["stun:stun.l.google.com:19302"]}]},G=function(t){Object(R.a)(n,t);var e=Object(V.a)(n);function n(t){var a;return Object(P.a)(this,n),(a=e.call(this)).pc=new RTCPeerConnection(q),a.pc.onicecandidate=function(t){return J.emit("call",{to:a.friendID,candidate:t.candidate,from:localStorage.getItem("id")})},a.pc.ontrack=function(t){return a.emit("peerStream",t.streams[0])},a.mediaDevice=new W,a.friendID=t,a}return Object(_.a)(n,[{key:"start",value:function(t,e){var n=this;return this.mediaDevice.on("stream",(function(e){e.getTracks().forEach((function(t){n.pc.addTrack(t,e)})),n.emit("localStream",e),t?J.emit("request",{from:localStorage.getItem("id"),to:n.friendID}):n.createOffer()})).start(e),this}},{key:"stop",value:function(t){return t&&J.emit("end",{to:this.friendID}),this.mediaDevice.stop(),this.pc.close(),this.pc=null,this.off(),this}},{key:"createOffer",value:function(){return this.pc.createOffer().then(this.getDescription.bind(this)).catch((function(t){return console.log(t)})),this}},{key:"createAnswer",value:function(){return this.pc.createAnswer().then(this.getDescription.bind(this)).catch((function(t){return console.log(t)})),this}},{key:"getDescription",value:function(t){return this.pc.setLocalDescription(t),J.emit("call",{to:this.friendID,sdp:t}),this}},{key:"setRemoteDescription",value:function(t){var e=new RTCSessionDescription(t);return this.pc.setRemoteDescription(e),this}},{key:"addIceCandidate",value:function(t){if(t){var e=new RTCIceCandidate(t);this.pc.addIceCandidate(e)}return this}}]),n}(U);var z=function(t){var e=t.startCall,n=t.clientId,i=Object(c.useState)(null),r=Object(N.a)(i,2),o=r[0],s=r[1],l=function(t){var n={audio:!0,video:t};return function(){return o&&e(!0,o,n)}};return Object(a.jsxs)("div",{className:"container main-window",children:[Object(a.jsxs)("div",{children:[Object(a.jsxs)("h3",{children:["Hi ",localStorage.getItem("name"),", your ID is",Object(a.jsx)("input",{type:"text",className:"txt-clientId",defaultValue:n,readOnly:!0})]}),Object(a.jsx)("h4",{children:"Get started by calling a friend below"})]}),Object(a.jsxs)("div",{children:[Object(a.jsx)("input",{type:"text",className:"txt-clientId",spellCheck:!1,placeholder:"Your friend ID",onChange:function(t){return s(t.target.value)}}),Object(a.jsxs)("div",{children:[Object(a.jsx)("button",{type:"button",className:"btn-action fa fa-video-camera",onClick:l(!0)}),Object(a.jsx)("button",{type:"button",className:"btn-action fa fa-phone",onClick:l(!1)})]})]})]})},X=n(4),Y=n.n(X),K=function(t,e){return Y()("btn-action fa ".concat(t),{disable:!e})};var Q=function(t){var e=t.peerSrc,n=t.localSrc,i=t.config,r=t.mediaDevice,o=t.status,s=t.endCall,l=Object(c.useRef)(null),u=Object(c.useRef)(null),d=Object(c.useState)(i.video),f=Object(N.a)(d,2),h=f[0],j=f[1],p=Object(c.useState)(i.audio),b=Object(N.a)(p,2),m=b[0],v=b[1];Object(c.useEffect)((function(){l.current&&e&&(l.current.srcObject=e),u.current&&n&&(u.current.srcObject=n)})),Object(c.useEffect)((function(){r&&(r.toggle("Video",h),r.toggle("Audio",m))}));var O=function(t){"video"===t&&(j(!h),r.toggle("Video")),"audio"===t&&(v(!m),r.toggle("Audio"))};return Object(a.jsxs)("div",{className:Y()("call-window",o),children:[Object(a.jsx)("video",{id:"peerVideo",ref:l,autoPlay:!0}),Object(a.jsx)("video",{id:"localVideo",ref:u,autoPlay:!0,muted:!0}),Object(a.jsxs)("div",{className:"video-control",children:[Object(a.jsx)("button",{type:"button",className:K("fa-video-camera",h),onClick:function(){return O("video")}},"btnVideo"),Object(a.jsx)("button",{type:"button",className:K("fa-microphone",m),onClick:function(){return O("audio")}},"btnAudio"),Object(a.jsx)("button",{type:"button",className:"btn-action hangup fa fa-phone",onClick:function(){return s(!0)}})]})]})};var Z=function(t){var e=t.status,n=t.callFrom,c=t.startCall,i=t.rejectCall,r=function(t){var e={audio:!0,video:t};return function(){return c(!1,n,e)}};return Object(a.jsxs)("div",{className:Y()("call-modal",e),children:[Object(a.jsx)("p",{children:Object(a.jsx)("span",{className:"caller",children:"".concat(n," is calling")})}),Object(a.jsx)("button",{type:"button",className:"btn-action fa fa-video-camera",onClick:r(!0)}),Object(a.jsx)("button",{type:"button",className:"btn-action fa fa-phone",onClick:r(!1)}),Object(a.jsx)("button",{type:"button",className:"btn-action hangup fa fa-phone",onClick:i})]})},$=function(t){Object(R.a)(n,t);var e=Object(V.a)(n);function n(){var t;return Object(P.a)(this,n),(t=e.call(this)).state={clientId:"",callWindow:"",callModal:"",callFrom:"",localSrc:null,peerSrc:null},t.pc={},t.config=null,t.startCallHandler=t.startCall.bind(Object(H.a)(t)),t.endCallHandler=t.endCall.bind(Object(H.a)(t)),t.rejectCallHandler=t.rejectCall.bind(Object(H.a)(t)),t}return Object(_.a)(n,[{key:"componentDidMount",value:function(){var t=this;J.on("init",(function(e){var n=e.id;document.title="".concat(n," - VideoCall"),t.setState({clientId:n})})).on("request",(function(e){var n=e.from;t.setState({callModal:"active",callFrom:n})})).on("call",(function(e){e.sdp?(t.pc.setRemoteDescription(e.sdp),"offer"===e.sdp.type&&t.pc.createAnswer()):t.pc.addIceCandidate(e.candidate)})).on("end",this.endCall.bind(this,!1)).emit("init",localStorage.getItem("id"))}},{key:"startCall",value:function(t,e,n){var a=this;this.config=n,this.pc=new G(e).on("localStream",(function(e){var n={callWindow:"active",localSrc:e};t||(n.callModal=""),a.setState(n)})).on("peerStream",(function(t){return a.setState({peerSrc:t})})).start(t,n)}},{key:"rejectCall",value:function(){var t=this.state.callFrom;J.emit("end",{to:t}),this.setState({callModal:""})}},{key:"endCall",value:function(t){B.a.isFunction(this.pc.stop)&&this.pc.stop(t),this.pc={},this.config=null,this.setState({callWindow:"",callModal:"",localSrc:null,peerSrc:null})}},{key:"render",value:function(){var t=this.state,e=t.clientId,n=t.callFrom,c=t.callModal,i=t.callWindow,r=t.localSrc,o=t.peerSrc;return Object(a.jsxs)("div",{children:[Object(a.jsx)(z,{clientId:e,startCall:this.startCallHandler}),!B.a.isEmpty(this.config)&&Object(a.jsx)(Q,{status:i,localSrc:r,peerSrc:o,config:this.config,mediaDevice:this.pc.mediaDevice,endCall:this.endCallHandler}),Object(a.jsx)(Z,{status:c,startCall:this.startCallHandler,rejectCall:this.rejectCallHandler,callFrom:n})]})}}]),n}(c.Component),tt=Object(s.b)((function(t){return{isAuth:t.isAuth}}),null)((function(t){return Object(a.jsx)(D.a,{children:Object(a.jsxs)(d.d,{children:[Object(a.jsx)(d.b,{exact:!0,path:"/login",component:F}),t.isAuth?Object(a.jsx)(d.b,{exact:!0,path:"/",component:$}):Object(a.jsx)(d.a,{to:"/login"})]})})})),et=(n(103),Object(u.a)()),nt={isAuth:!1},at=window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__||l.b;k.auth.validate().then((function(t){"ok"===t.msg&&(nt.isAuth=!0)})).catch((function(t){})).finally((function(){var t=Object(l.c)(w,nt,at());o.a.render(Object(a.jsx)(s.a,{store:t,children:Object(a.jsx)(d.c,{history:et,children:Object(a.jsx)(tt,{})})}),document.getElementById("root"))})),f()},96:function(t,e){},99:function(t,e,n){}},[[104,1,2]]]);
//# sourceMappingURL=main.7806e70a.chunk.js.map